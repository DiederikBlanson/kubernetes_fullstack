# Adding Multiple Nodes to a Kubernetes Cluster

### Step 1: Install microk8s on worker node
Install microk8s [1] without addons etc

```bash
sudo snap install microk8s --classic

sudo usermod -a -G microk8s $USER
sudo chown -f -R $USER ~/.kube
su - $USER
```

### Step 2: Add New Node to /etc/hosts
First, you must add the new node's IP address and hostname to the /etc/hosts file on all nodes in the cluster. To do this, run the following command on each node, replacing node-ip and node-name with the appropriate values:
```bash
sudo echo "[worker-ip] [worker-name"] << /etc/hosts
```

From the worker, allow all traffic from the controller:
```bash
sudo ufw allow from [ip-controller]
```

From the controller, allow all traffic from the worker:
```bash
sudo ufw allow from [ip-worker]
```

<br/>

### Step 3: Generate a Token for the New Node
In order to connect the new node to the control plane (master), a token must be generated by the control plane. Run the following command on the control plane:

```bash
microk8s add-node
```

Note: this token is valid for a short amount of time.

<br/>

### Step 4: Choose the Type of Node
On the new node, run the command provided in the output of the previous step to join the cluster as a worker or master node.


<br/>

## Other Commands
- To view the pods on a specific node, run the following command, replacing <node> with the node's hostname: 
```bash
kubectl get pods --all-namespaces -o wide --field-selector spec.nodeName=<node_name>
```

<br/>

## Deschedule Node
In order to make a node unschedulable, execute the following command:
```bash
kubectl cordon <node_name>
```
If you want to make it unschedulable and remove all resources attached to the node, execute the following command. It does not remove the node from the cluster, but makes it unschedulable.
```bash
kubectl drain <node_name> --ignore-daemonsets
```
To make it schedulable again:
```bash
kubectl uncordon <node_name>
```

----
sources: 
- [1] https://ubuntu.com/tutorials/getting-started-with-kubernetes-ha#4-create-a-microk8s-multinode-cluster
- [2] https://github.com/canonical/microk8s/issues/2488